name: Infra-auto-with-Terra

on: 
 push:
    branches:
     - Terraform-infra

 pull_request:
    branches:
     - main


jobs:
    Install_terraform:
        runs-on: self-hosted
        steps:
            - name: update the runner
              run: |
               echo "updating the ec2"
               sudo apt-get update -y

            - name: Install Terraform
              run: |
               echo "Installing Terraform..."
               sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
               wget -O- https://apt.releases.hashicorp.com/gpg | \
               gpg --dearmor | \
               sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
               gpg --no-default-keyring \
               --keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg \
               --fingerprint
               echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
               https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
               sudo tee /etc/apt/sources.list.d/hashicorp.list
               sudo apt update
               sudo apt-get install terraform




    Set-UP-Infra:
        runs-on: self-hosted
        needs: Install_terraform
        env:
            AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}     
            AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}  
            
        steps:

            - name: code checkout
              uses: actions/checkout@v3

           # - name: setup AWS creds
           #   uses: actions/configure-aws-credentials@v1
           #   with:
           #     AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}     
           #     AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
           #     region: ap-south-1

            - name: Terraform init
              run: terraform init
              
            - name: Terraform validate
              run: terraform validate

            - name: Terraform plan
              run: terraform plan | grep "#"

            - name: Terraform apply
              run: terraform apply -auto-approve
